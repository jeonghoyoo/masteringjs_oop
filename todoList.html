<script>
const todoListArr = [];  //{id = ##, title = #####, state=#### ,startTime = ####, finishTime = ######}
const TODO_INFO_INDEX = {
    //#1. when command add
    COMMAND_INDEX : 0,
    ADD_TITLE : 1,
    //#2. when command update
    UPDATE_ID_INDEX : 1,
    UPDATE_STATE : 2,
    //#3. when command show
    SHOW_STATE : 1
};
const TASK_STATE = {
    TODO : 'todo',
    DOING : 'doing',
    DONE : 'done'
};
const COMMAND_OPTION = {
    ADD : 'add',
    UPDATE : 'update',
    SHOW : 'show'
};
//Todo 관련 일반 함수 모음 Class
const TodoCommon = class{
    //#1. return 총 작업시간 (with 시작시간, 종료시간)
    getWorkingHoursFormat(startTime, finishTime = Date.now()){
        const TIME_CONVERT_VALUE = {
            SECONDS : 1000,
            MINUTES : 60,
            HOURS   : 3600
        };

        if(startTime === undefined) return;
        let workingHourStr = "";

        //소요시간을 초로 계산
        let divideValue = TIME_CONVERT_VALUE.SECONDS;
        let consumeTime = (finishTime - startTime) / divideValue;
        
        //#1. 소요시간을 구함
        divideValue = TIME_CONVERT_VALUE.HOURS;
        workingHourStr += this.getConsumeValueWithFactor(consumeTime, divideValue, "H");
        consumeTime %= divideValue;

        //#2. 소요시간값을 제외한 나머지 분을 구함
        divideValue = TIME_CONVERT_VALUE.MINUTES;
        workingHourStr += this.getConsumeValueWithFactor(consumeTime, divideValue, "M");

        //#3. 소요 시간 & 분을 제외한 나머지 초를 구함
        workingHourStr += this.getConsumeValueWithFactor(consumeTime);
        return workingHourStr;
    };

    //#2. return 시,분,초 (with consume, factor)
    getConsumeValueWithFactor(totalConsume, targetFactor = 1, timeFlag = "S"){
        let calcValue = Math.floor(totalConsume / targetFactor);
        if(timeFlag === "H"){
            return  calcValue > 0 ? (calcValue + "시간") : "";
        }else if(timeFlag === "M"){
            return  calcValue > 0 ? (calcValue + "분") : "";
        }else if(timeFlag === "S"){
            return  calcValue > 0 ? (calcValue + "초") : "";
        }
        return "";
    }
}

//Todo 명령어에 따른 함수 모음
const TodoCommand = class {
    constructor(){
        this.todoCommon = new TodoCommon();
    }
    implementAddCommand(optionArr){
        const jobObj = {};
        jobObj.id = this.getNewTaskId();
        jobObj.title = optionArr[TODO_INFO_INDEX.ADD_TITLE];
        jobObj.state = TASK_STATE.TODO;
        todoListArr.push(jobObj);
        console.log(`id : ${jobObj.id}, \"${jobObj.title}\" 항목이 새로 추가됐습니다.`);
        return this.getCommandReturnObj(true, optionArr)
    }

    implementUpdateCommand(optionArr){
        //#1. update ID에 맞는 todo task 찾기
        const updateTargetObj = this.getTargetObjWithID(parseInt(optionArr[TODO_INFO_INDEX.UPDATE_ID_INDEX]));
        if(!updateTargetObj) return this.getCommandReturnObj(false);

        //#2. 찾은 Ojbect state 변경하기
        const updateState = optionArr[TODO_INFO_INDEX.UPDATE_STATE];
        const priorState = updateTargetObj.state;

        //#2-1. TASK_STATE가 가지고 있는 값과 동일한 update state 입력여부 확인
        Object.keys(TASK_STATE).forEach((key,index) =>{
            if(updateState === TASK_STATE[key]){
                updateTargetObj.state = TASK_STATE[key];
            }
        });

        //#3. state에 따른 추가 정보 변경
        if(updateTargetObj.state === priorState) {
            return this.getCommandReturnObj(false);
        }else{
            if(updateTargetObj.state === TASK_STATE.DOING){
                //state = doing, set startTime value
                updateTargetObj.startTime = Date.now();
            }else if(updateTargetObj.state === TASK_STATE.DONE){
                //state = done, set startTimeValue
                updateTargetObj.finishTime = Date.now();
            }else{
                //state = todo
                console.log(priorState + '상태에서 todo 상태로 되돌릴 수 없습니다.');
                return this.getCommandReturnObj(false);
            }
        }

        //#4. update todoListArr with updateTargetObj
        this.replaceTargetObjToList(updateTargetObj);
        return this.getCommandReturnObj(true, optionArr);
    }

    implementShowCommand(optionArr){
        const chosenShowState = optionArr[TODO_INFO_INDEX.SHOW_STATE];
        const filterArr = todoListArr.filter(todoInfo => todoInfo.state === chosenShowState);
        return this.getCommandReturnObj(true, optionArr, filterArr);
    }
    //#1. Return 명령어에 따른 안내문을 출력하기 위한 Object 
    getCommandReturnObj(returnFlag = true, optionArr = null ,filteredMap = null){
        return {
            "returnFlag" : returnFlag,
            "commandStr" : optionArr ? optionArr[TODO_INFO_INDEX.COMMAND_INDEX] : null,
            "filteredMap" : filteredMap
        }
    }
    //#2. Return Next Todo Job ID
    getNewTaskId(){
       return todoListArr.length + 1;
    }

    //#3. Return 상태 그룹 별 Count 수
    getStateGroupCountObject(){
        const outputObj = {};
        Object.keys(TASK_STATE).forEach((key,index) =>{
            outputObj[TASK_STATE[key]] = 0;
            todoListArr.forEach((mapInfo, index) => {
                if(mapInfo.state === TASK_STATE[key]){
                    outputObj[TASK_STATE[key]]++;
                }
            });
        });

        return outputObj;
    };
    //#4. Return 상태 update 대상 object
    getTargetObjWithID(updateId){
        let targetObj;
        todoListArr.some((todoInfo, index) => {
            if(todoInfo.id === updateId){
                targetObj = todoInfo;
                targetObj.index = index;
                return true;
            }
        })
        return targetObj;
    };

    //#5. replace Updated Object to List
    replaceTargetObjToList(targetObj){
        const targetIndex = targetObj.index;
        //불필요한 object 내 index 값 삭제
        delete targetObj.index;
        return Object.assign(
            [...todoListArr], 
            {targetIndex : targetObj}
        );
    };
    

    // 각 명령어 별 안내사항 출력
    printDetailInfoWithCommand(paramObj){
        if(paramObj.returnFlag === false) return;
        
        const commandStr = paramObj.commandStr;
        const filteredMap = paramObj.filteredMap;

        const countObj = this.getStateGroupCountObject();
        if(commandStr === COMMAND_OPTION.ADD){
            console.log(`현재상태 : todo:${countObj.todo}개, doing:${countObj.doing}개, done:${countObj.done}개`);
        }else if(commandStr === COMMAND_OPTION.SHOW){
            if(filteredMap === null || filteredMap.length === 0){
                console.log("요청하신 Show 명령어에 대한 Task가 없습니다.");
            }else{
                let showPrintStr = "";
                filteredMap.forEach((mapInfo, index) => {
                    index > 0 ? showPrintStr += `,` : ``;
                    showPrintStr += `'${mapInfo.id}, ${mapInfo.title}` 
                    showPrintStr += (mapInfo.state === TASK_STATE.DONE) ? ", "+this.todoCommon.getWorkingHoursFormat(mapInfo.startTime, mapInfo.finishTime)+"'" : "'";
                });
                console.log(showPrintStr);
            }
        }else if(commandStr === COMMAND_OPTION.UPDATE){
            console.log(`현재상태 : todo:${countObj.todo}개, doing:${countObj.doing}개, done:${countObj.done}개`);
        }else{
            console.log("exception error!!!");
        }
    };
}

const Todo = class {
    constructor(){
        this.todoCommand = new TodoCommand();
    }
    setOptionArr(optionArr){
        this.optionArr = optionArr;
    }
    commandPipe(...functions){
        return args => {
            //pipe로 함수 호출 시 this가 undefined이기에 this를 파라미터로 전달
            return functions.reduce((arg, nextFn) => nextFn(arg, this), args); 
        }
    }

    command(commandStr){
        //#0. TodoCommand 내 실행해야 할 함수를 Return 받음
        const todoJob = this.commandPipe(
        //#1. $ split
        this.splitCommandLine,
        //#2. 각 항목 공백 제거 , #3. 명령어 toLowerCase
        this.rearrangeCommandOptions,
        //#3. 사용자 입력 명령어에 따른 작업 수행
        this.getTodoJob
        )(commandStr);

        //#4-1. 명령어에 따른 실제 Todo List 변경작업 함수 실행 with(this binding)
        //#4-2. 명령어에 따른 함수 실행 후 작업내용 출력
        this.todoCommand.printDetailInfoWithCommand(todoJob.apply(this.todoCommand, [this.optionArr]))
    }

    //#1. todoList 명령어 $ split
    splitCommandLine(commandStr){
        return commandStr.split("$");
    }

    //#2. 명령어와 옵션 공백제거 & lowerCase
    rearrangeCommandOptions(optionArr) {
        return optionArr.map(option => option.trim().toLowerCase());
    }
    //#3. TodoCommand class 내에 실행해야 할 함수를 Return
    getTodoJob(optionArr, bindThis){
        const todoCommand = bindThis.todoCommand;
        const commandStr = optionArr[TODO_INFO_INDEX.COMMAND_INDEX];

        bindThis.setOptionArr(optionArr);
        if(commandStr === COMMAND_OPTION.ADD){
            //명령어가 add 일 때 
            return todoCommand.implementAddCommand;
        }else if(commandStr === COMMAND_OPTION.SHOW){
            //명령어가 show 일 때 
            return todoCommand.implementShowCommand;
        }else if(commandStr === COMMAND_OPTION.UPDATE){
            //명령어가 update 일 때 
            return todoCommand.implementUpdateCommand;
        }else{
            //기타 명령어가 들어왔을 때
            return function(){
                console.log("없는 명령어입니다.");
            };
        }
    }
};

const todo = new Todo();
todo.command("add$자바스크립트 공부하기");
todo.command("add$Todo test");
todo.command("add$Todo 실행");
todo.command("update$3$doing");
todo.command("shOW     $doing");
//todo.command("update$3$done");
//todo.command("show$done");

</script>